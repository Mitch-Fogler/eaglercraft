<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mitch's Sigma Chess</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1   { text-align:center; margin-bottom:10px; }
    #game-options{ text-align:center; margin-bottom:10px; }
    #status{ text-align:center; margin-top:15px; font-size:20px; }
    #version{ text-align:center; font-size:10px; margin-top:10px; }

    /* board + eval‑bar + analysis */
    #board-container{ display:flex; justify-content:center; align-items:flex-start; margin-bottom:10px; }
    #evalBarContainer{ display:none; width:12px; height:480px; margin-right:10px; border:1px solid #333; }
    #evalBar{ width:100%; height:100%; background:#eee; }

    /* chessboard */
    #chessboard{ display:inline-block; }
    table{ border-collapse:collapse; }
    td{ width:60px; height:60px; text-align:center; vertical-align:middle;
        font-size:42px; cursor:pointer; user-select:none; }
    .light{ background:#f0d9b5; } .dark{ background:#b58863; } .selected{ outline:3px solid red; }

    /* hidden groups */
    #single-difficulty,#losing-depth,#engine-levels,#worst-depth-control,
    #setup-controls,#piece-palette,#analysis-controls{ display:none; }

    /* palette */
    #piece-palette{ margin:10px auto; width:600px; text-align:center; }
    #piece-palette button{ font-size:24px; margin:2px; padding:5px 10px; }

    /* buttons */
    #resetButton,#startEngineVsEngine,#finishSetupButton{ margin-top:10px; padding:5px 15px; font-size:16px; }

    /* analysis panel */
    #analysis-panel{ width:260px; margin-left:10px; font-size:14px; line-height:1.3; display:none; }
    #analysis-panel button,#analysis-panel select{ margin:4px 0; font-size:14px; width:100%; }
    #pv-list{ max-height:300px; overflow-y:auto; padding:0; list-style:none; margin:4px 0; }
    #pv-list li{ padding:2px 4px; cursor:pointer; } #pv-list li:hover{ background:#eef; }
    #pv-list .pv-header{ font-weight:bold; }
  </style>
</head>
<body>
  <h1>Mitch's Sigma Chess</h1>

  <div id="game-options">
    <label>Game Mode:</label>
    <select id="modeSelect">
      <option value="twoplayer">Two Player</option>
      <option value="stockfish">Play Against Stockfish</option>
      <option value="losing">Losing Mode</option>
      <option value="enginevengine">Engine vs Engine</option>
      <option value="setup">Setup Position</option>
      <option value="analysis">Analysis Mode</option>
    </select>

    <!-- eval‑bar toggle -->
    <label><input type="checkbox" id="evalBarToggle"/> Show eval bar</label>

    <!-- Start‑analysis button (appears only in Analysis mode) -->
    <span id="analysis-controls"><button id="startAnalysis">Start Analysis</button></span>
  </div>

  <!-- existing difficulty / depth / palette / setup UI (unchanged) -->
  … <!-- KEEP YOUR ORIGINAL SINGLE‑PLAYER, LOSING, ENGINE‑LEVEL, SETUP CONTROLS HERE -->

  <!-- Palette for setup -->
  <div id="piece-palette"></div>

  <!-- board + eval bar + analysis panel -->
  <div id="board-container">
    <div id="evalBarContainer"><div id="evalBar"></div></div>
    <div id="chessboard"></div>

    <!-- NEW analysis panel -->
    <div id="analysis-panel">
      <button id="stopAnalysis" disabled>Stop Analysis</button>
      <button id="hideAnalysis">Hide</button>

      <label>Depth:</label>
      <select id="depthSelect">
        <option>8</option><option>10</option><option>12</option><option>14</option>
        <option selected>16</option><option>18</option><option>20</option>
      </select>

      <label># Lines:</label>
      <div style="display:flex; align-items:center;">
        <button id="decreaseLines">−</button>
        <span id="linesCount" style="flex:1; text-align:center;">3</span>
        <button id="increaseLines">+</button>
      </div>

      <label>Eval:</label> <span id="numericEval">0.00</span>

      <ul id="pv-list">
        <li class="pv-header">Principal Variations:</li>
      </ul>

      <button id="importFEN">Import FEN</button>
      <button id="importPGN">Import PGN</button>
      <button id="setupPosition">Setup Position</button>
      <button id="playPosition">Play Position</button>
    </div>
  </div>

  <button id="startEngineVsEngine">Start Engine vs Engine</button>
  <button id="resetButton">Reset Game</button>
  <div id="status"></div>
  <div id="version">v.1.8</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <script>
  /* =======   EVERYTHING BELOW IS YOUR ORIGINAL CODE, EXCEPT:  =======
     1.  old FEN‑based analysis handler removed
     2.  new analysis engine/panel logic added at the bottom
     ================================================================== */

  // ---- your unchanged globals, board drawing, OTB, Stockfish, Losing, Engine‑v‑Engine, Setup … ----
  // (  ... keep all existing code down to the old analysis section  )

  /* =================  NEW 365Chess‑style ANALYSIS SECTION  ================= */

  let engine=null, isAnalyzing=false, pvCount=3;

  function initAnalysisEngine(){
    if(engine) engine.terminate();
    engine = new Worker('stockfish.js');
    engine.onmessage = e => onAnalysisMsg(e.data);
    engine.postMessage('uci');
  }

  function startAnalysis(){
    initAnalysisEngine();
    isAnalyzing = true;
    document.getElementById('stopAnalysis').disabled = false;
    document.getElementById('analysis-panel').style.display = 'block';
    sendAnalysis();
  }
  function stopAnalysis(){
    isAnalyzing = false;
    document.getElementById('stopAnalysis').disabled = true;
    if(engine) engine.postMessage('stop');
  }

  // buttons
  document.getElementById('startAnalysis').onclick = startAnalysis;
  document.getElementById('stopAnalysis').onclick  = stopAnalysis;
  document.getElementById('hideAnalysis').onclick  = () => {
    document.getElementById('analysis-panel').style.display='none';
    stopAnalysis();
  };

  document.getElementById('increaseLines').onclick = () => {
    pvCount = Math.min(10, pvCount+1);
    document.getElementById('linesCount').textContent=pvCount;
    if(isAnalyzing) sendAnalysis();
  };
  document.getElementById('decreaseLines').onclick = () => {
    pvCount = Math.max(1, pvCount-1);
    document.getElementById('linesCount').textContent=pvCount;
    if(isAnalyzing) sendAnalysis();
  };
  document.getElementById('depthSelect').onchange = () => { if(isAnalyzing) sendAnalysis(); };

  function sendAnalysis(){
    engine.postMessage('ucinewgame');
    engine.postMessage('position fen '+game.fen());
    engine.postMessage('setoption name MultiPV value '+pvCount);
    engine.postMessage('setoption name UCI_AnalyseMode value true');
    engine.postMessage('go depth '+(+document.getElementById('depthSelect').value));
  }

  function onAnalysisMsg(line){
    if(!line.startsWith('info')) return;
    const t=line.split(' '), mp=t.indexOf('multipv'), sc=t.indexOf('score'), pv=t.indexOf('pv');
    if(mp>-1 && sc>-1 && pv>-1 && t[sc+1]==='cp'){
      const num=+t[mp+1], cp=+t[sc+2], moves=t.slice(pv+1);
      if(num===1)
        document.getElementById('numericEval').textContent=(cp>=0?'+':'')+(cp/100).toFixed(2);
      updatePV(num,cp,moves);
    }
  }

  function updatePV(num,cp,moves){
    const ul=document.getElementById('pv-list');
    let li=ul.querySelector(`li[data-pv="${num}"]`);
    if(!li){
      li=document.createElement('li'); li.dataset.pv=num;
      li.onclick=()=>{ game.reset(); moves.forEach(m=>game.move(m)); drawBoard(); };
      ul.appendChild(li);
    }
    li.textContent=`${num}. ${moves.join(' ')} (${(cp/100).toFixed(2)})`;
  }

  // import / position buttons
  document.getElementById('importFEN').onclick = () => {
    const fen=prompt('Paste FEN:'); if(fen&&game.load(fen)) drawBoard(); else alert('Bad FEN');
  };
  document.getElementById('importPGN').onclick = () => {
    const pgn=prompt('Paste PGN:'); try{game.load_pgn(pgn); drawBoard();}catch{alert('Bad PGN');}
  };
  document.getElementById('setupPosition').onclick = () => {
    document.getElementById('modeSelect').value='setup';
    document.getElementById('modeSelect').dispatchEvent(new Event('change'));
  };
  document.getElementById('playPosition').onclick = () => {
    customFEN = game.fen();
    document.getElementById('modeSelect').value='twoplayer';
    document.getElementById('modeSelect').dispatchEvent(new Event('change'));
  };

  /* =======  MODIFY MODE‑SWITCH TOGGLE  ======= */
  const originalModeHandler = document.getElementById('modeSelect').onchange;
  document.getElementById('modeSelect').onchange = () => {
    currentMode = document.getElementById('modeSelect').value;
    // show Start Analysis only in analysis mode
    document.getElementById('analysis-controls').style.display =
      currentMode==='analysis' ? 'inline' : 'none';
    // hide panel when leaving analysis
    if(currentMode!=='analysis'){ stopAnalysis(); document.getElementById('analysis-panel').style.display='none'; }
    originalModeHandler(); // run the rest of your existing handler
  };

  /* =======  INITIALIZE  ======= */
  window.onload = () => {
    createBoard(); drawBoard(); updateStatus();
    document.getElementById('analysis-controls').style.display='none';
  };
  </script>
</body>
</html>
