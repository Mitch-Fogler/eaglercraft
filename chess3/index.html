<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mitch's Sigma Chess</title>
  <link rel="stylesheet" href="https://unpkg.com/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"/>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; margin-bottom: 10px; }
    #game-options { text-align: center; margin-bottom: 10px; }
    #status { text-align: center; margin-top: 15px; font-size: 20px; }
    #version { text-align: center; font-size: 10px; margin-top: 10px; }

    /* Container for board + analysis panel */
    #board-container { display: flex; justify-content: center; align-items: flex-start; }
    #analysis-panel {
      width: 260px; margin-left: 10px; font-size: 14px; line-height: 1.3;
      display: none;  /* only visible in Analysis mode */
    }
    #analysis-panel button,
    #analysis-panel select,
    #analysis-panel input { margin: 4px 0; font-size: 14px; }

    /* Chessboard */
    #chessboard { width: 480px; }
    table { border-collapse: collapse; }
    td {
      width: 60px; height: 60px;
      text-align: center; vertical-align: middle;
      font-size: 42px; cursor: pointer; user-select: none;
    }
    .light { background: #f0d9b5; }
    .dark  { background: #b58863; }
    .selected { outline: 3px solid red; }

    /* Hide old eval bar */
    #evalBarContainer { display: none !important; }

    /* Analysis panel styles */
    #pv-list { max-height: 300px; overflow-y: auto; padding: 0; list-style: none; margin: 4px 0; }
    #pv-list li { padding: 2px 4px; cursor: pointer; }
    #pv-list li:hover { background: #eef; }
    #pv-list .pv-header { font-weight: bold; }
  </style>
</head>
<body>
  <h1>Mitch's Sigma Chess</h1>

  <!-- Mode selector -->
  <div id="game-options">
    <label>Game Mode:</label>
    <select id="modeSelect">
      <option value="twoplayer">Two Player</option>
      <option value="stockfish">Play Against Stockfish</option>
      <option value="losing">Losing Mode</option>
      <option value="enginevengine">Engine vs Engine</option>
      <option value="setup">Setup Position</option>
      <option value="analysis">Analysis Mode</option>
    </select>
  </div>

  <!-- Board + Analysis Panel -->
  <div id="board-container">
    <div id="chessboard"></div>
    <div id="analysis-panel">
      <div class="button-group">
        <button id="stopAnalysis" disabled>Stop Analysis</button>
        <button id="hideAnalysis">Hide</button>
      </div>
      <div>
        <label for="depthSelect">Depth:</label>
        <select id="depthSelect">
          <option>8</option><option>10</option><option>12</option><option>14</option>
          <option selected>16</option><option>18</option><option>20</option><option>22</option><option>24</option>
        </select>
      </div>
      <div>
        <label># Lines:</label>
        <button id="decreaseLines">–</button>
        <span id="linesCount">3</span>
        <button id="increaseLines">+</button>
      </div>
      <div>
        <label>Eval:</label>
        <span id="numericEval">0.00</span>
      </div>
      <ul id="pv-list">
        <li class="pv-header">Principal Variations:</li>
      </ul>
      <hr>
      <div>
        <button id="importFEN">Import FEN</button>
        <button id="importPGN">Import PGN</button>
      </div>
      <div>
        <button id="setupPosition">Setup Position</button>
        <button id="playPosition">Play Position</button>
      </div>
    </div>
  </div>

  <!-- Status and version -->
  <div id="status"></div>
  <div id="version">v.1.8</div>

  <!-- Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <script src="https://unpkg.com/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
  <script>
    // === Globals ===
    const game = new Chess();
    let board, engine, stockfishWhite, stockfishBlack;
    let isAnalyzing = false;

    // === Initialize Board ===
    function initBoard() {
      board = Chessboard('chessboard', {
        draggable: true,
        position: 'start',
        onDrop: onMove
      });
      updateStatus();
    }

    // === Status Update ===
    function updateStatus() {
      let s = '';
      if (game.in_checkmate()) {
        s = `Game over: ${game.turn()==='w'?'Black':'White'} wins by checkmate.`;
      } else if (game.in_draw()) {
        s = 'Game over: drawn position.';
      } else {
        s = `${game.turn()==='w'?'White':'Black'} to move.` +
            (game.in_check() ? ' Check!' : '');
      }
      document.getElementById('status').textContent = s;
    }

    // === Move Handling ===
    function onMove(src, dst) {
      const m = game.move({ from: src, to: dst, promotion: 'q' });
      if (!m) return 'snapback';
      board.position(game.fen());
      updateStatus();
      // no engine auto‑response in Analysis mode
    }

    // === Mode Change ===
    document.getElementById('modeSelect').addEventListener('change', () => {
      const mode = document.getElementById('modeSelect').value;
      document.getElementById('analysis-panel').style.display =
        mode === 'analysis' ? 'block' : 'none';
      if (mode === 'analysis') startAnalysis();
      else stopAnalysis();
      resetGame();
    });

    // === Analysis Controls ===
    document.getElementById('stopAnalysis').addEventListener('click', stopAnalysis);
    document.getElementById('hideAnalysis').addEventListener('click', () => {
      document.getElementById('analysis-panel').style.display = 'none';
      stopAnalysis();
    });
    document.getElementById('increaseLines').addEventListener('click', () => {
      let n = +document.getElementById('linesCount').textContent;
      if (n < 10) document.getElementById('linesCount').textContent = ++n;
      if (isAnalyzing) sendAnalysis();
    });
    document.getElementById('decreaseLines').addEventListener('click', () => {
      let n = +document.getElementById('linesCount').textContent;
      if (n > 1) document.getElementById('linesCount').textContent = --n;
      if (isAnalyzing) sendAnalysis();
    });
    document.getElementById('depthSelect').addEventListener('change', () => {
      if (isAnalyzing) sendAnalysis();
    });

    // === Start/Stop Analysis ===
    function startAnalysis() {
      initEngine();
      isAnalyzing = true;
      document.getElementById('stopAnalysis').disabled = false;
      sendAnalysis();
    }
    function stopAnalysis() {
      isAnalyzing = false;
      document.getElementById('stopAnalysis').disabled = true;
      if (engine) engine.postMessage('stop');
    }

    // === Send UCI for MultiPV ===
    function sendAnalysis() {
      if (!engine) return;
      engine.postMessage('ucinewgame');
      engine.postMessage(`position fen ${game.fen()}`);
      const depth = document.getElementById('depthSelect').value;
      const lines = document.getElementById('linesCount').textContent;
      engine.postMessage(`setoption name MultiPV value ${lines}`);
      engine.postMessage('setoption name UCI_AnalyseMode value true');
      engine.postMessage(`go depth ${depth}`);
    }

    // === Engine Message Parsing ===
    function onEngineMessage(e) {
      const line = e.data;
      if (line.startsWith('info')) parseInfo(line);
    }

    // === Parse 'info' for MultiPV ===
    function parseInfo(line) {
      const tokens = line.split(' ');
      const mpvIdx = tokens.indexOf('multipv');
      const scIdx = tokens.indexOf('score');
      if (mpvIdx>-1 && scIdx>-1 && tokens[scIdx+1]==='cp') {
        const mpv = +tokens[mpvIdx+1];
        const cp  = +tokens[scIdx+2];
        // Update numeric evaluation for PV1
        if (mpv === 1) {
          const pawns = (cp/100).toFixed(2);
          document.getElementById('numericEval')
            .textContent = (pawns>=0?'+':'') + pawns;
        }
        // Extract PV moves
        const pvIdx = tokens.indexOf('pv');
        if (pvIdx > -1) {
          const moves = tokens.slice(pvIdx+1);
          updatePVList(mpv, cp, moves);
        }
      }
    }

    // === Render PV Lines ===
    function updatePVList(num, cp, moves) {
      const ul = document.getElementById('pv-list');
      let li = ul.querySelector(`li[data-pv="${num}"]`);
      if (!li) {
        li = document.createElement('li');
        li.dataset.pv = num;
        ul.appendChild(li);
        li.addEventListener('click', () => {
          game.reset();
          moves.forEach(mv => game.move(mv));
          board.position(game.fen());
          updateStatus();
        });
      }
      const pawns = (cp/100).toFixed(2);
      li.textContent = `${num}. ${moves.join(' ')} (${pawns})`;
    }

    // === Stockfish Worker ===
    function initEngine() {
      if (engine) engine.terminate();
      engine = new Worker('stockfish.js');
      engine.onmessage = onEngineMessage;
      engine.postMessage('uci');
    }

    // === Import / Setup / Play ===
    document.getElementById('importFEN').addEventListener('click', () => {
      const fen = prompt('Paste FEN:');
      if (fen && game.load(fen)) board.position(game.fen());
      else alert('Invalid FEN');
    });
    document.getElementById('importPGN').addEventListener('click', () => {
      const pgn = prompt('Paste PGN:');
      try { game.load_pgn(pgn); board.position(game.fen()); }
      catch { alert('Invalid PGN'); }
    });
    document.getElementById('setupPosition').addEventListener('click', () => {
      document.getElementById('modeSelect').value = 'setup';
      document.getElementById('modeSelect')
        .dispatchEvent(new Event('change'));
    });
    document.getElementById('playPosition').addEventListener('click', () => {
      customFEN = game.fen();
      document.getElementById('modeSelect').value = 'twoplayer';
      document.getElementById('modeSelect')
        .dispatchEvent(new Event('change'));
    });

    // === Reset Game (preserve custom FEN) ===
    let customFEN = null;
    function resetGame() {
      if (customFEN && document.getElementById('modeSelect').value!=='setup')
        game.load(customFEN);
      else game.reset();
      board.position(game.fen());
      updateStatus();
    }

    // === Initialize on Load ===
    window.onload = () => {
      initBoard();
      updateStatus();
      document.getElementById('modeSelect').value = 'twoplayer';
    };
  </script>
</body>
</html>
