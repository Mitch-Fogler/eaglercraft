<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mitch's Sigma Chess</title>
  <style>
    /* Basic layout */
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; margin-bottom: 10px; }
    #game-options { text-align: center; margin-bottom: 10px; }
    #status { text-align: center; margin-top: 15px; font-size: 20px; }

    /* Board */
    #chessboard { margin: 0 auto; display: inline-block; }
    table { border-collapse: collapse; }
    td {
      width: 60px; height: 60px;
      text-align: center; vertical-align: middle;
      font-size: 42px;
      cursor: pointer; user-select: none;
    }
    .light { background: #f0d9b5; }
    .dark  { background: #b58863; }
    .selected { outline: 3px solid red; }

    /* Controls */
    #resetButton, #startEngineVsEngine, #finishSetupButton {
      margin-top: 10px; padding: 5px 15px; font-size: 16px;
    }
    #version { text-align: center; font-size: 10px; margin-top: 10px; }

    /* Hide all extra control groups by default */
    #single-difficulty,
    #losing-depth,
    #engine-levels,
    #worst-depth-control,
    #setup-controls,
    #piece-palette {
      display: none;
    }

    /* Palette styling */
    #piece-palette {
      margin: 10px auto; width: 600px; text-align: center;
    }
    #piece-palette button {
      font-size: 24px; margin: 2px; padding: 5px 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Mitch's Sigma Chess</h1>

  <div id="game-options">
    <label>Game Mode:</label>
    <select id="modeSelect">
      <option value="twoplayer">Two Player</option>
      <option value="stockfish">Play Against Stockfish</option>
      <option value="losing">Losing Mode</option>
      <option value="enginevengine">Engine vs Engine</option>
      <option value="setup">Setup Position</option>
    </select>

    <!-- Single-player difficulty -->
    <span id="single-difficulty">
      <label>Difficulty:</label>
      <select id="difficultySelect">
        <option value="-1">-1</option>
        <option>0</option><option>1</option><option>2</option><option>3</option>
        <option>4</option><option selected>5</option><option>6</option><option>7</option>
        <option>8</option><option>9</option><option>10</option><option>11</option>
        <option>12</option><option>13</option><option>14</option><option>15</option>
        <option>16</option><option>17</option><option>18</option><option>19</option>
        <option>20</option>
      </select>
    </span>

    <!-- Losing-depth -->
    <span id="losing-depth">
      <label>Losing Depth:</label>
      <select id="losingDepthSelect">
        <option>1</option><option>2</option><option>3</option><option>4</option>
        <option>5</option><option>6</option><option>7</option><option>8</option>
        <option>9</option><option selected>10</option><option>11</option><option>12</option>
        <option>13</option><option>14</option><option>15</option><option>16</option>
        <option>17</option><option>18</option><option>19</option><option>20</option>
      </select>
    </span>

    <!-- Engine vs engine levels -->
    <span id="engine-levels">
      <label>White Skill:</label>
      <select id="whiteDifficultySelect">
        <option value="-1">-1</option>
        <option>0</option><option>1</option><option>2</option><option>3</option>
        <option>4</option><option selected>5</option><option>6</option><option>7</option>
        <option>8</option><option>9</option><option>10</option><option>11</option>
        <option>12</option><option>13</option><option>14</option><option>15</option>
        <option>16</option><option>17</option><option>18</option><option>19</option>
        <option>20</option>
      </select>
      <label>Black Skill:</label>
      <select id="blackDifficultySelect">
        <option value="-1">-1</option>
        <option>0</option><option>1</option><option>2</option><option>3</option>
        <option>4</option><option selected>5</option><option>6</option><option>7</option>
        <option>8</option><option>9</option><option>10</option><option>11</option>
        <option>12</option><option>13</option><option>14</option><option>15</option>
        <option>16</option><option>17</option><option>18</option><option>19</option>
        <option>20</option>
      </select>
    </span>

    <!-- Worst-move depth for -1 -->
    <span id="worst-depth-control">
      <label>Worst Move Depth (for -1):</label>
      <input type="number" id="worstDepthInput" min="1" max="20" value="10"/>
    </span>

    <!-- Setup controls -->
    <span id="setup-controls">
      <div>Setup Position (select palette, then click square):</div>
      <label>Turn:</label>
      <select id="turnSelect">
        <option value="w" selected>White to move</option>
        <option value="b">Black to move</option>
      </select>
      <button id="finishSetupButton">Finish Setup</button>
    </span>
  </div>

  <!-- Piece palette -->
  <div id="piece-palette"></div>

  <!-- Engine vs engine start -->
  <button id="startEngineVsEngine">Start Engine vs Engine</button>

  <!-- Board & status -->
  <div id="chessboard"></div>
  <div id="status"></div>
  <button id="resetButton">Reset Game</button>

  <!-- Version -->
  <div id="version">v.1.8</div>

  <!-- chess.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <script>
    // === Globals ===
    var game = new Chess();
    var boardDiv = document.getElementById('chessboard');
    var currentMode = 'twoplayer';
    var humanColor = 'w';
    var customFEN = null;
    var boardSetup = {};
    var selectedPalettePiece = '';
    var selectedSquare = null;
    var files = ['a','b','c','d','e','f','g','h'];

    // Engine workers
    var stockfish, stockfishWhite, stockfishBlack;

    // === Board rendering ===
    function createBoard() {
      var tbl = document.createElement('table');
      for (var i=0; i<8; i++) {
        var tr = document.createElement('tr');
        var rank = 8 - i;
        for (var j=0; j<8; j++) {
          var td = document.createElement('td');
          var sq = files[j] + rank;
          td.id = sq;
          td.className = (i+j)%2? 'light':'dark';
          td.addEventListener('click', onCellClick);
          tr.appendChild(td);
        }
        tbl.appendChild(tr);
      }
      boardDiv.innerHTML = '';
      boardDiv.appendChild(tbl);
    }

    function getUnicode(piece) {
      var m = {
        p:{w:'♙',b:'♟'},
        r:{w:'♖',b:'♜'},
        n:{w:'♘',b:'♞'},
        b:{w:'♗',b:'♝'},
        q:{w:'♕',b:'♛'},
        k:{w:'♔',b:'♚'}
      };
      return m[piece.type][piece.color];
    }

    function drawBoard() {
      var b = game.board();
      for (var i=0; i<8; i++) {
        var rank = 8 - i;
        for (var j=0; j<8; j++) {
          var sq = files[j] + rank;
          var td = document.getElementById(sq);
          var pc = b[i][j];
          td.innerHTML = pc? getUnicode(pc): '';
          td.classList.remove('selected');
        }
      }
      updateStatus();
    }

    function drawSetupBoard() {
      for (var r=8; r>=1; r--) {
        for (var f=0; f<8; f++) {
          var sq = files[f] + r;
          var td = document.getElementById(sq);
          var code = boardSetup[sq]||'';
          td.innerHTML = code? getUnicode({ type: code[1], color: code[0] }): '';
        }
      }
    }

    function updateStatus() {
      var s = '';
      if (game.in_checkmate()) {
        s = 'Game over: ' + (game.turn()==='w'?'Black':'White') + ' wins by checkmate.';
      } else if (game.in_draw()) {
        s = 'Game over: drawn position.';
      } else {
        s = (game.turn()==='w'?'White':'Black') + ' to move.' + (game.in_check()?' Check!':'');
      }
      document.getElementById('status').textContent = s;
    }

    // === Palette ===
    function createPiecePalette() {
      var pal = document.getElementById('piece-palette');
      var items = [
        {lbl:'Clear', code:''},
        {lbl:'♙', code:'wp'},{lbl:'♘', code:'wn'},{lbl:'♗', code:'wb'},
        {lbl:'♖', code:'wr'},{lbl:'♕', code:'wq'},{lbl:'♔', code:'wk'},
        {lbl:'♟', code:'bp'},{lbl:'♞', code:'bn'},{lbl:'♝', code:'bb'},
        {lbl:'♜', code:'br'},{lbl:'♛', code:'bq'},{lbl:'♚', code:'bk'}
      ];
      pal.innerHTML = '';
      items.forEach(function(it) {
        var btn = document.createElement('button');
        btn.innerText = it.lbl;
        btn.onclick = function(){ selectPalettePiece(it.code); };
        pal.appendChild(btn);
      });
      selectPalettePiece('');  // default select “clear”
    }

    function selectPalettePiece(code) {
      selectedPalettePiece = code;
      Array.from(document.getElementById('piece-palette').children)
        .forEach(function(b){
          b.style.border = ( (code===''
            ? b.innerText==='Clear'
            : b.innerText === getUnicode({type:code[1],color:code[0]}) )
            ? '2px solid red':'');
        });
    }

    // === Click handler ===
    function onCellClick(e) {
      var sq = e.currentTarget.id;
      if (currentMode==='setup') {
        boardSetup[sq] = selectedPalettePiece;
        drawSetupBoard();
        return;
      }
      if (currentMode==='enginevengine') return;
      // normal move:
      if (!selectedSquare) {
        var pc = game.get(sq);
        if (!pc || pc.color!==game.turn()) return;
        if ((currentMode==='stockfish'||currentMode==='losing') && pc.color!==humanColor) return;
        selectedSquare = sq; e.currentTarget.classList.add('selected');
      } else {
        if (selectedSquare===sq) { 
          document.getElementById(sq).classList.remove('selected');
          selectedSquare = null; return;
        }
        // handle promotion
        var promo='q', pc=game.get(selectedSquare);
        if (pc && pc.type==='p' && ((pc.color==='w'&&sq.endsWith('8'))||(pc.color==='b'&&sq.endsWith('1')))) {
          var c=prompt('Promote to (q,r,b,n):','q');
          if (c&&( 'qrbn'.includes(c.toLowerCase()) )) promo=c.toLowerCase();
        }
        var mv = game.move({from:selectedSquare,to:sq,promotion:promo});
        if (!mv) alert('Invalid!');
        selectedSquare=null; drawBoard();
        // engine response
        if ((currentMode==='stockfish'||currentMode==='losing') && game.turn()!==humanColor && !game.game_over()) {
          if (currentMode==='stockfish') {
            var d=parseInt(document.getElementById('difficultySelect').value,10);
            if (d===-1) {
              var wd=parseInt(document.getElementById('worstDepthInput').value,10)||10;
              setTimeout(function(){
                chooseWorstMoveUsingStockfish(wd).then(function(m){ if(m) game.move(m); drawBoard(); });
              },250);
            } else setTimeout(function(){ askEngineForMove(game.fen()); },250);
          } else {
            setTimeout(function(){
              chooseWorstMoveUsingStockfish().then(function(m){ if(m) game.move(m); drawBoard(); });
            },250);
          }
        }
      }
    }

    // === Setup mode ===
    function initializeSetupBoard(){
      boardSetup = {};
      for(var r=1;r<=8;r++)for(var f of files)boardSetup[f+r]='';
      drawSetupBoard();
    }
    function finishSetup(){
      var turn=document.getElementById('turnSelect').value;
      var parts=[];
      for(var rank=8;rank>=1;rank--){
        var row='',empty=0;
        for(var f of files){
          var c=boardSetup[f+rank]||'';
          if(!c) empty++;
          else{
            if(empty){ row+=empty; empty=0; }
            var L=c[1]; L = c[0]==='w'?L.toUpperCase():L.toLowerCase();
            row+=L;
          }
        }
        if(empty) row+=empty;
        parts.push(row);
      }
      customFEN = parts.join('/')+' '+turn+' - - 0 1';
      game.load(customFEN);
      drawBoard();
      alert('Position set. Switch mode to play.');
    }

    // === Stockfish integration ===
    function initStockfish(){
      if(typeof Worker==='undefined'){console.error('No Web Workers');return;}
      if(!stockfish){
        stockfish=new Worker('stockfish.js');
        stockfish.onmessage=function(e){
          var m=e.data;
          if(m.startsWith('bestmove')){
            var mv=m.split(' ')[1];
            if(mv!=='(none)'){
              var mo=fixEnginePromotion(mv,game.fen());
              game.move(mo); drawBoard();
            }
          }
        };
        stockfish.postMessage('uci');
        setTimeout(function(){ updateSingleEngineDifficulty(); },500);
      } else updateSingleEngineDifficulty();
    }
    function updateSingleEngineDifficulty(){
      var d=document.getElementById('difficultySelect').value;
      stockfish.postMessage('setoption name Skill Level value '+d);
    }
    function askEngineForMove(fen){
      stockfish.postMessage('position fen '+fen);
      stockfish.postMessage('go movetime 500');
    }

    function evaluateMoveWithStockfish(fen,depth=12){
      return new Promise(function(res){
        var w=new Worker('stockfish.js'),score=null;
        w.onmessage=function(e){
          var L=e.data;
          if(L.includes('score cp')){
            var m=L.match(/score cp (-?\d+)/);
            if(m) score=parseInt(m[1],10);
          }
          if(L.startsWith('bestmove')){
            w.terminate(); res(score);
          }
        };
        w.postMessage('uci');
        setTimeout(function(){
          w.postMessage('position fen '+fen);
          w.postMessage('go depth '+depth);
        },200);
      });
    }
    function chooseWorstMoveUsingStockfish(customDepth){
      var moves=game.moves({verbose:true});
      if(!moves.length) return Promise.resolve(null);
      var depth=customDepth!==undefined?customDepth:parseInt(document.getElementById('losingDepthSelect').value,10);
      var promises=moves.map(function(m){
        var c=new Chess(game.fen()); c.move(m);
        return evaluateMoveWithStockfish(c.fen(),depth).then(function(s){return {move:m,score:s};});
      });
      return Promise.all(promises).then(function(results){
        return results.reduce(function(a,b){return b.score>a.score?b:a;},results[0]).move;
      });
    }

    function getEnginePromotionMove(fen,from,to){
      var p=['q','r','b','n'];
      for(var pi of p){
        var c=new Chess(fen);
        var mv=c.move({from:from,to:to,promotion:pi});
        if(mv && !c.in_draw()) return {from:from,to:to,promotion:pi};
      }
      return {from:from,to:to,promotion:'q'};
    }
    function fixEnginePromotion(bestMove,fen){
      var f=bestMove.substr(0,2),t=bestMove.substr(2,2);
      if(bestMove.length===5){
        var pr=bestMove[4];
        var c=new Chess(fen);
        c.move({from:f,to:t,promotion:pr});
        if(c.in_draw()) return getEnginePromotionMove(fen,f,t);
        else return {from:f,to:t,promotion:pr};
      }
      return {from:f,to:t};
    }

    // === Engine vs Engine ===
    function initEngineVsEngine(){
      if(stockfish){stockfish.terminate(); stockfish=null;}
      if(typeof Worker==='undefined'){console.error('No W');return;}
      // White
      if(!stockfishWhite){
        stockfishWhite=new Worker('stockfish.js');
        stockfishWhite.onmessage=function(e){
          var m=e.data;
          if(m.startsWith('bestmove') && game.turn()==='w'){
            var mv=m.split(' ')[1];
            if(mv!=='(none)'){
              var mo=fixEnginePromotion(mv,game.fen());
              game.move(mo); drawBoard();
              setTimeout(autoPlayEngineVsEngine,250);
            }
          }
        };
        stockfishWhite.postMessage('uci');
        setTimeout(function(){ updateEngineDifficulty('w'); },500);
      } else updateEngineDifficulty('w');
      // Black
      if(!stockfishBlack){
        stockfishBlack=new Worker('stockfish.js');
        stockfishBlack.onmessage=function(e){
          var m=e.data;
          if(m.startsWith('bestmove') && game.turn()==='b'){
            var mv=m.split(' ')[1];
            if(mv!=='(none)'){
              var mo=fixEnginePromotion(mv,game.fen());
              game.move(mo); drawBoard();
              setTimeout(autoPlayEngineVsEngine,250);
            }
          }
        };
        stockfishBlack.postMessage('uci');
        setTimeout(function(){ updateEngineDifficulty('b'); },500);
      } else updateEngineDifficulty('b');
      autoPlayEngineVsEngine();
    }
    function updateEngineDifficulty(side){
      var val=document.getElementById(side==='w'?'whiteDifficultySelect':'blackDifficultySelect').value;
      (side==='w'?stockfishWhite:stockfishBlack).postMessage('setoption name Skill Level value '+val);
    }
    function autoPlayEngineVsEngine(){
      if(game.game_over()){ updateStatus(); return; }
      var fen=game.fen();
      var turn=game.turn();
      var diff= parseInt(document.getElementById(turn==='w'?'whiteDifficultySelect':'blackDifficultySelect').value,10);
      if(diff===-1){
        var wd=parseInt(document.getElementById('worstDepthInput').value,10)||10;
        chooseWorstMoveUsingStockfish(wd).then(function(mv){
          if(mv) game.move(mv);
          drawBoard();
          setTimeout(autoPlayEngineVsEngine,250);
        });
      } else {
        var worker = turn==='w'?stockfishWhite:stockfishBlack;
        worker.postMessage('position fen '+fen);
        worker.postMessage('go movetime 500');
      }
    }

    // === UI logic ===
    function updateWorstDepthControlVisibility(){
      var m=currentMode;
      var show=false;
      if(m==='stockfish' && document.getElementById('difficultySelect').value==='-1') show=true;
      if(m==='enginevengine' && (document.getElementById('whiteDifficultySelect').value==='-1' || document.getElementById('blackDifficultySelect').value==='-1')) show=true;
      document.getElementById('worst-depth-control').style.display = show?'inline':'none';
    }

    function updateUI(){
      var m=document.getElementById('modeSelect').value;
      currentMode=m;
      // show/hide groups
      document.getElementById('single-difficulty').style.display = m==='stockfish'?'inline':'none';
      document.getElementById('losing-depth').style.display = m==='losing'?'inline':'none';
      document.getElementById('engine-levels').style.display = m==='enginevengine'?'inline':'none';
      document.getElementById('setup-controls').style.display = m==='setup'?'inline':'none';
      document.getElementById('startEngineVsEngine').style.display = m==='enginevengine'?'inline-block':'none';
      document.getElementById('piece-palette').style.display = m==='setup'?'block':'none';
      updateWorstDepthControlVisibility();

      if(m==='setup'){
        initializeSetupBoard();
        createPiecePalette();
      }
      // when leaving setup (but not entering enginevengine), restore custom position if any
      if(m!=='setup' && m!=='enginevengine' && customFEN){
        game.load(customFEN);
        drawBoard();
      }
    }

    function resetGame(){
      if(customFEN && currentMode!=='setup') game.load(customFEN);
      else game.reset();
      selectedSquare=null; drawBoard();
      if(currentMode==='enginevengine') setTimeout(autoPlayEngineVsEngine,250);
    }

    // === Event listeners ===
    document.getElementById('modeSelect').addEventListener('change',function(){
      updateUI(); resetGame();
    });
    document.getElementById('difficultySelect').addEventListener('change',updateWorstDepthControlVisibility);
    document.getElementById('whiteDifficultySelect').addEventListener('change',updateWorstDepthControlVisibility);
    document.getElementById('blackDifficultySelect').addEventListener('change',updateWorstDepthControlVisibility);
    document.getElementById('finishSetupButton').addEventListener('click',finishSetup);
    document.getElementById('startEngineVsEngine').addEventListener('click',initEngineVsEngine);
    document.getElementById('resetButton').addEventListener('click',resetGame);

    // === Init on load ===
    createBoard();
    drawBoard();
    updateUI();
  </script>
</body>
</html>
