<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mitch's Sigma Chess</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; margin-bottom: 10px; }
    #game-options { text-align: center; margin-bottom: 10px; }
    #status { text-align: center; margin-top: 15px; font-size: 20px; }
    #version { text-align: center; font-size: 10px; margin-top: 10px; }

    /* Board & Eval‑Bar & Analysis container */
    #board-container {
      display: flex; justify-content: center; align-items: flex-start;
      margin-bottom: 10px;
    }
    #evalBarContainer { display: none; }
    #evalBar { width:100%; height:100%; background:#eee; }

    /* Chessboard */
    #chessboard { display: inline-block; }
    table { border-collapse: collapse; }
    td {
      width:60px; height:60px;
      text-align:center; vertical-align:middle;
      font-size:42px; cursor:pointer; user-select:none;
    }
    .light { background:#f0d9b5; }
    .dark  { background:#b58863; }
    .selected { outline:3px solid red; }

    /* Analysis Panel */
    #analysis-panel {
      width:260px; margin-left:10px; font-size:14px; line-height:1.3;
      display: none;
    }
    #analysis-panel button,
    #analysis-panel select {
      margin:4px 0; font-size:14px; width:100%;
    }
    #pv-list {
      max-height:300px; overflow-y:auto; padding:0; list-style:none;
      margin:4px 0;
    }
    #pv-list li { padding:2px 4px; cursor:pointer; }
    #pv-list li:hover { background:#eef; }
    #pv-list .pv-header { font-weight:bold; }
  </style>
</head>
<body>
  <h1>Mitch's Sigma Chess</h1>

  <div id="game-options">
    <label>Game Mode:</label>
    <select id="modeSelect">
      <option value="twoplayer">Two Player</option>
      <option value="stockfish">Play Against Stockfish</option>
      <option value="losing">Losing Mode</option>
      <option value="enginevengine">Engine vs Engine</option>
      <option value="setup">Setup Position</option>
      <option value="analysis">Analysis Mode</option>
    </select>

    <!-- Show/hide the Start Analysis button only in Analysis mode -->
    <span id="analysis-controls" style="display:none;">
      <button id="startAnalysis">Start Analysis</button>
    </span>
  </div>

  <!-- Piece palette and other controls unchanged... -->
  <div id="piece-palette"></div>

  <!-- Board + Eval‑Bar + Analysis Panel -->
  <div id="board-container">
    <div id="evalBarContainer"><div id="evalBar"></div></div>
    <div id="chessboard"></div>
    <div id="analysis-panel">
      <button id="stopAnalysis" disabled>Stop Analysis</button>
      <button id="hideAnalysis">Hide</button>
      <label>Depth:</label>
      <select id="depthSelect">
        <option>8</option><option>10</option><option>12</option><option>14</option>
        <option selected>16</option><option>18</option><option>20</option>
      </select>
      <label># Lines:</label>
      <div style="display:flex; align-items:center;">
        <button id="decreaseLines">−</button>
        <span id="linesCount" style="flex:1; text-align:center;">3</span>
        <button id="increaseLines">+</button>
      </div>
      <label>Eval:</label> <span id="numericEval">0.00</span>
      <ul id="pv-list">
        <li class="pv-header">Principal Variations:</li>
      </ul>
      <button id="importFEN">Import FEN</button>
      <button id="importPGN">Import PGN</button>
      <button id="setupPosition">Setup Position</button>
      <button id="playPosition">Play Position</button>
    </div>
  </div>

  <button id="startEngineVsEngine">Start Engine vs Engine</button>
  <button id="resetButton">Reset Game</button>
  <div id="status"></div>
  <div id="version">v.1.8</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <script>
  // === Globals ===
  const game = new Chess();
  const files = ['a','b','c','d','e','f','g','h'];
  let currentMode = 'twoplayer', humanColor = 'w', customFEN = null;
  let selectedSquare = null;
  let engine = null, isAnalyzing = false, pvCount = 3;

  // === Board Rendering ===
  function createBoard(){
    const boardDiv = document.getElementById('chessboard');
    let html = '<table>';
    for(let r=8;r>=1;r--){
      html += '<tr>';
      for(let f=0;f<8;f++){
        const sq = files[f] + r;
        html += `<td id="${sq}" class="${(f+r)%2?'light':'dark'}"></td>`;
      }
      html += '</tr>';
    }
    html += '</table>';
    boardDiv.innerHTML = html;
    document.querySelectorAll('#chessboard td').forEach(td=>{
      td.onclick = onCellClick;
    });
  }

  function drawBoard(){
    const b = game.board();
    for(let r=8;r>=1;r--){
      for(let f=0;f<8;f++){
        const sq = files[f]+r;
        const td = document.getElementById(sq);
        const pc = b[8-r][f];
        td.textContent = pc ? unicode(pc) : '';
        td.classList.remove('selected');
      }
    }
    updateStatus();
  }

  function unicode(p){
    const m = {
      p:{w:'♙',b:'♟'}, r:{w:'♖',b:'♜'},
      n:{w:'♘',b:'♞'}, b:{w:'♗',b:'♝'},
      q:{w:'♕',b:'♛'}, k:{w:'♔',b:'♚'}
    };
    return m[p.type][p.color];
  }

  function updateStatus(){
    let s = '';
    if(game.in_checkmate()){
      s = `Game over: ${game.turn()==='w'?'Black':'White'} wins by checkmate.`;
    } else if(game.in_draw()){
      s = 'Game over: drawn position.';
    } else {
      s = `${game.turn()==='w'?'White':'Black'} to move.` +
          (game.in_check() ? ' Check!' : '');
    }
    document.getElementById('status').textContent = s;
  }

  // === Cell Click (only for OTB, not analysis) ===
  function onCellClick(e){
    if(currentMode === 'analysis') return; // no board moves in analysis
    // ... your existing onCellClick logic for other modes ...
    // (unchanged)
  }

  // === Mode Switch ===
  document.getElementById('modeSelect').onchange = () => {
    currentMode = document.getElementById('modeSelect').value;
    // show/hide Start Analysis button
    document.getElementById('analysis-controls').style.display =
      currentMode==='analysis' ? 'inline' : 'none';
    // hide panel when leaving
    if(currentMode!=='analysis'){
      stopAnalysis();
      document.getElementById('analysis-panel').style.display = 'none';
    }
    // reset the game for all other modes
    // ... your existing resetGame() logic ...
  };

  // === Analysis Core ===
  function initAnalysisEngine(){
    if(engine) engine.terminate();
    engine = new Worker('stockfish.js');
    engine.onmessage = e => onAnalysisMsg(e.data);
    engine.postMessage('uci');
  }

  function startAnalysis(){
    initAnalysisEngine();
    isAnalyzing = true;
    document.getElementById('stopAnalysis').disabled = false;
    document.getElementById('analysis-panel').style.display = 'block';
    sendAnalysis();
  }
  document.getElementById('startAnalysis').onclick = startAnalysis;

  function stopAnalysis(){
    isAnalyzing = false;
    document.getElementById('stopAnalysis').disabled = true;
    if(engine) engine.postMessage('stop');
  }
  document.getElementById('stopAnalysis').onclick = stopAnalysis;

  document.getElementById('hideAnalysis').onclick = () => {
    document.getElementById('analysis-panel').style.display = 'none';
    stopAnalysis();
  };

  document.getElementById('increaseLines').onclick = () => {
    pvCount = Math.min(10, pvCount + 1);
    document.getElementById('linesCount').textContent = pvCount;
    if(isAnalyzing) sendAnalysis();
  };
  document.getElementById('decreaseLines').onclick = () => {
    pvCount = Math.max(1, pvCount - 1);
    document.getElementById('linesCount').textContent = pvCount;
    if(isAnalyzing) sendAnalysis();
  };
  document.getElementById('depthSelect').onchange = () => {
    if(isAnalyzing) sendAnalysis();
  };

  function sendAnalysis(){
    engine.postMessage('ucinewgame');
    engine.postMessage('position fen ' + game.fen());
    engine.postMessage('setoption name MultiPV value ' + pvCount);
    engine.postMessage('setoption name UCI_AnalyseMode value true');
    engine.postMessage('go depth ' + (+document.getElementById('depthSelect').value));
  }

  function onAnalysisMsg(line){
    if(!line.startsWith('info')) return;
    const t = line.split(' ');
    const mpvIdx = t.indexOf('multipv');
    const scIdx  = t.indexOf('score');
    const pvIdx  = t.indexOf('pv');
    if(mpvIdx > -1 && scIdx > -1 && pvIdx > -1 && t[scIdx+1]==='cp'){
      const num  = +t[mpvIdx+1];
      const cp   = +t[scIdx+2];
      const moves = t.slice(pvIdx+1);
      if(num===1){
        document.getElementById('numericEval')
          .textContent = (cp>=0?'+':'') + (cp/100).toFixed(2);
      }
      updatePVList(num, cp, moves);
    }
  }

  function updatePVList(num, cp, moves){
    const ul = document.getElementById('pv-list');
    let li = ul.querySelector(`li[data-pv="${num}"]`);
    if(!li){
      li = document.createElement('li');
      li.dataset.pv = num;
      li.onclick = () => playPV(moves);
      ul.appendChild(li);
    }
    li.textContent = `${num}. ${moves.join(' ')} (${(cp/100).toFixed(2)})`;
  }

  function playPV(moves){
    game.reset();
    moves.forEach(mv => game.move(mv));
    drawBoard();
  }

  document.getElementById('importFEN').onclick = () => {
    const fen = prompt('Paste FEN:');
    if(fen && game.load(fen)) drawBoard();
    else alert('Invalid FEN');
  };
  document.getElementById('importPGN').onclick = () => {
    const pgn = prompt('Paste PGN:');
    try{ game.load_pgn(pgn); drawBoard(); }
    catch{ alert('Invalid PGN'); }
  };
  document.getElementById('setupPosition').onclick = () => {
    document.getElementById('modeSelect').value = 'setup';
    document.getElementById('modeSelect').dispatchEvent(new Event('change'));
  };
  document.getElementById('playPosition').onclick = () => {
    customFEN = game.fen();
    document.getElementById('modeSelect').value = 'twoplayer';
    document.getElementById('modeSelect').dispatchEvent(new Event('change'));
  };

  // === Initialization ===
  window.onload = () => {
    createBoard();
    drawBoard();
    updateStatus();
    // show startAnalysis only in analysis mode
    document.getElementById('analysis-controls').style.display = 'none';
  };
  </script>
</body>
</html>
